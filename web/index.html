<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LUA Playground</title>
        <link rel="stylesheet" href="//cdn.kaisnet.de/bootstrap/5.0.2/css/bootstrap.min.css" />
        <link rel="stylesheet" href="//cdn.kaisnet.de/codemirror/5.65.6/codemirror.min.css" />
        <style>
            body {
                margin-top: 50px;
            }

            #result {
                white-space: pre;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="mb-5">
                <div class="mb-3">
                    <div class="border rounded">
                        <textarea name="code" id="code" rows="10"></textarea>
                    </div>
                </div>
                <div id="result" class="mb-3 px-3 py-2 text-muted border rounded d-none"></div>
            </div>

            <div class="text-end">
                <button type="button" id="exec" class="btn btn-primary">Execute</button>
            </div>
        </div>

        <script src="//cdn.kaisnet.de/codemirror/5.65.6/codemirror.min.js"></script>
        <script src="//cdn.kaisnet.de/codemirror/5.65.6/mode/lua/lua.js"></script>
        <script>
            var editor = CodeMirror.fromTextArea(code, {
                lineNumbers: true,
            })

            function addResultLine(resultBox, text) {
                const pElement = document.createElement('p')
                pElement.classList.add('m-0')
                pElement.textContent = text
                resultBox.append(pElement)
            }

            const execBtn = document.getElementById('exec')
            execBtn.addEventListener('click', function (ev) {
                ev.preventDefault()
                const code = editor.getValue().trim()
                if (code.length > 0) {
                    fetch('/exec', {
                        method: 'POST',
                        mode: 'cors',
                        body: code,
                    })
                        .then(function (response) {
                            return response.json()
                        })
                        .then(function (response) {
                            const resultBox = document.getElementById('result')
                            resultBox.innerHTML = ''
                            if (response.o) {
                                const lines = response.o.split('\n')
                                for (i = 0; i < lines.length; i++) {
                                    addResultLine(resultBox, lines[i])
                                }
                            } else {
                                addResultLine(resultBox, 'No output')
                            }

                            if (response.c !== 0) {
                                resultBox.classList.add('border-danger')
                            } else {
                                resultBox.classList.remove('border-danger')
                            }

                            resultBox.classList.remove('d-none')
                        })
                        .catch(function (reason) {})
                }
            })
        </script>
    </body>
</html>
